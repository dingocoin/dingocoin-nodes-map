# ============================================
# CADDYFILE FOR HOST-INSTALLED CADDY
# ============================================
# This is a ONE-TIME INFRASTRUCTURE SETUP template.
# Use this when you have Caddy installed on your HOST system (not in Docker)
# and want to reverse proxy to your node map application.
#
# IMPORTANT: This file is NEVER auto-generated or deployed by CI/CD.
# Infrastructure config (like nginx config) is separate from application deployment.
#
# ============================================
# SETUP INSTRUCTIONS
# ============================================
# 1. Copy this file and customize it with your actual values:
#    cp docker/Caddyfile.host.example /tmp/nodesmap.Caddyfile
#
# 2. Replace ALL placeholders below:
#    FROM .env (or AWS SSM Parameter Store):
#      - SITE_URL → Extract domain (e.g., nodes.dingocoin.org)
#      - API_EXTERNAL_URL → Extract domain (e.g., api.nodes.dingocoin.org)
#      - WEB_PORT → Container host port (default: 4000)
#      - KONG_PORT → Kong host port (default: 4020)
#
#    FROM deployment scenario:
#      - Choose http:// (Cloudflare Flexible TLS) or bare domain (Direct HTTPS)
#      - Comment out API block if using Cloud mode (Supabase Cloud)
#
# 3. Deploy to server (manual, one-time):
#    sudo cp /tmp/nodesmap.Caddyfile /etc/caddy/sites/nodesmap.Caddyfile
#    sudo chown root:root /etc/caddy/sites/nodesmap.Caddyfile
#    sudo chmod 644 /etc/caddy/sites/nodesmap.Caddyfile
#    sudo systemctl reload caddy
#
# 4. Verify /etc/caddy/Caddyfile imports your file:
#    import /etc/caddy/sites/*.Caddyfile
#
# ============================================
# IF YOU CHANGE PORTS LATER
# ============================================
# You must update BOTH places:
# 1. AWS SSM Parameter Store (for automated deployments)
# 2. This Caddyfile (infrastructure config)
#
# Ports are stored in SSM because:
# - Multi-deployment support (multiple forks on same server)
# - Environment-specific values (dev vs prod)
# - Infrastructure concern (like DB passwords)
# ============================================

# ============================================
# SCENARIO 1: Cloudflare Flexible TLS
# ============================================
# WHEN TO USE:
# - Using Cloudflare as CDN/DNS
# - Cloudflare SSL/TLS mode: Flexible
# - Cloudflare terminates HTTPS, proxies HTTP to you
#
# CLOUDFLARE CONFIGURATION REQUIRED:
# - SSL/TLS mode: Flexible
# - Always Use HTTPS: OFF (prevent redirect loops)
# - Proxy status: Enabled (orange cloud)
#
# PLACEHOLDERS TO REPLACE:
# - nodes.example.com → Your actual domain from SITE_URL
# - api.nodes.example.com → Your actual domain from API_EXTERNAL_URL
# - localhost:4000 → WEB_PORT from .env (default: 4000)
# - localhost:4020 → KONG_PORT from .env (default: 4020)
# ============================================

# ================================
# WEB APP
# ================================
http://nodes.example.com {

    # --- Next.js static assets (aggressive caching) ---
    handle /_next/static/* {
        reverse_proxy localhost:4000 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port 443
        }
        header Cache-Control "public, max-age=31536000, immutable"
    }

    # --- Public images ---
    handle /images/* {
        reverse_proxy localhost:4000 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port 443
        }
        header Cache-Control "public, max-age=2592000"
    }

    # --- Favicon ---
    handle /favicon.ico {
        reverse_proxy localhost:4000 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port 443
        }
        header Cache-Control "public, max-age=86400"
    }

    # --- Catch-all: Next.js app ---
    handle {
        reverse_proxy localhost:4000 {
            header_up X-Forwarded-Proto https
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port 443
            header_up X-Forwarded-For {remote}
            header_up X-Real-IP {remote_host}
        }
    }

    # --- Security headers (NO HSTS for Flexible TLS) ---
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
        Referrer-Policy "strict-origin-when-cross-origin"
    }

    encode gzip
}

# ================================
# API (Supabase Kong Gateway)
# ================================
# ONLY FOR SELF-HOSTED MODE (prod-docker-no-caddy)
# If using Cloud mode (prod-cloud-no-caddy), COMMENT THIS OUT
# because your API is hosted on Supabase Cloud, not locally.
# ================================
http://api.nodes.example.com {
    # Proxy to Kong API Gateway (Supabase)
    reverse_proxy localhost:4020 {
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Port 443
        header_up X-Forwarded-For {remote}
        header_up Host {host}
        header_up X-Real-IP {remote_host}
    }

    # --- Security headers ---
    header {
        X-Frame-Options "SAMEORIGIN"
        X-Content-Type-Options "nosniff"
    }

    encode gzip
}

# ============================================
# SCENARIO 2: Direct HTTPS (No Cloudflare)
# ============================================
# WHEN TO USE:
# - NOT using Cloudflare
# - Want Caddy to handle HTTPS directly via Let's Encrypt
# - Need automatic SSL certificates
#
# REQUIREMENTS:
# - Ports 80 and 443 must be open
# - DNS A records pointing to your server
# - Valid email for Let's Encrypt notifications
#
# SETUP:
# Replace http:// blocks above with bare domains.
# Caddy will automatically get Let's Encrypt certificates.
# Add HSTS header for security.
#
# EXAMPLE:
#
# nodes.example.com {
#     # Same handle blocks as above...
#     reverse_proxy localhost:4000
#
#     # Add HSTS for Direct HTTPS
#     header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     encode gzip
# }
#
# api.nodes.example.com {
#     reverse_proxy localhost:4020
#     header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     encode gzip
# }
# ============================================

# ============================================
# SCENARIO 3: Multi-Chain Server
# ============================================
# WHEN TO USE:
# - Running multiple blockchain node maps on the same server
# - Each fork on different ports
#
# EXAMPLE:
# Each project gets its own port range:
# - Dingocoin: WEB_PORT=4000, KONG_PORT=4020
# - Bitcoin:   WEB_PORT=5000, KONG_PORT=5020
# - Dogecoin:  WEB_PORT=6000, KONG_PORT=6020
#
# http://nodes.bitcoin.org {
#     reverse_proxy localhost:5000
# }
#
# http://api.nodes.bitcoin.org {
#     reverse_proxy localhost:5020
# }
#
# http://nodes.dogecoin.org {
#     reverse_proxy localhost:6000
# }
#
# http://api.nodes.dogecoin.org {
#     reverse_proxy localhost:6020
# }
# ============================================

# ============================================
# TROUBLESHOOTING
# ============================================
#
# Issue: "502 Bad Gateway"
# Fix: Verify containers are running and ports match .env:
#      cd /apps/your-project && docker compose ps
#      docker compose logs web
#      docker compose logs kong
#
# Issue: "connection refused"
# Fix: Check if ports are exposed:
#      docker port atlasp2p-web
#      Should show: 0.0.0.0:4000->3000/tcp
#
# Issue: "certificate error" (Direct HTTPS mode)
# Fix: Ensure ports 80 and 443 are open:
#      sudo ufw allow 80/tcp
#      sudo ufw allow 443/tcp
#
# Issue: Redirect loop (Cloudflare Flexible TLS)
# Fix: In Cloudflare dashboard:
#      - Set SSL/TLS mode to "Flexible"
#      - Turn OFF "Always Use HTTPS"
#
# Issue: Changes not taking effect
# Fix: Reload Caddy after editing:
#      sudo systemctl reload caddy
#      sudo systemctl status caddy
#
# Issue: Syntax errors
# Fix: Validate config before reloading:
#      sudo caddy validate --config /etc/caddy/Caddyfile
# ============================================
