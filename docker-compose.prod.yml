# ============================================
# PRODUCTION OVERRIDES
# ============================================
# Single entry point via Caddy reverse proxy.
# Auto-SSL with Let's Encrypt.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   make prod
#
# Exposed Ports:
#   80  - HTTP (redirects to HTTPS)
#   443 - HTTPS (Caddy with auto-SSL)
#
# Required Environment Variables:
#   DOMAIN - Your domain (e.g., nodes.example.com)
#   ACME_EMAIL - Email for Let's Encrypt (e.g., admin@example.com)
# ============================================

services:
  # ===========================================
  # REVERSE PROXY (Single Entry Point)
  # ===========================================
  # Only included when using --profile with-caddy
  # Use prod-docker-no-caddy if you have host Caddy
  caddy:
    image: caddy:2-alpine
    container_name: atlasp2p-caddy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN}
      - ACME_EMAIL=${ACME_EMAIL}
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - atlasp2p_caddy-data:/data
      - atlasp2p_caddy-config:/config
    depends_on:
      - web
      - kong
    restart: unless-stopped
    profiles:
      - with-caddy

  # Production web app
  # Uses pre-built image from CI/CD (GHCR or ECR)
  # When with-caddy profile: no exposed ports (Caddy proxies)
  # When no-caddy: expose port 4000 for external reverse proxy
  web:
    # IMPORTANT: Override with image, no build in production
    # Setting build: null doesn't work - must omit build entirely
    # and re-declare the service to override base config
    image: ${REGISTRY}/${IMAGE_PREFIX}web:${IMAGE_TAG}
    container_name: atlasp2p-web
    env_file:
      - .env
    ports:
      - "${WEB_PORT}:3000"  # Exposed when NOT using Caddy
    environment:
      - NODE_ENV=production
      - WEB_TARGET=production
      - SUPABASE_INTERNAL_URL=http://kong:8000
      # Use API_EXTERNAL_URL from .env (supports both same-origin and separate subdomain)
      - NEXT_PUBLIC_SUPABASE_URL=${API_EXTERNAL_URL}
    volumes:
      - avatar-storage:/app/public/avatars
      - web-next-cache:/app/apps/web/.next/cache
    depends_on:
      - kong
    restart: unless-stopped

  # Kong API Gateway
  # Exposed when NOT using container Caddy (for host-based reverse proxy)
  kong:
    ports:
      - "${KONG_PORT}:8000"  # Exposed for external reverse proxy

  # Override auth for production URLs
  auth:
    environment:
      API_EXTERNAL_URL: ${API_EXTERNAL_URL}
      GOTRUE_SITE_URL: ${SITE_URL}
      GOTRUE_URI_ALLOW_LIST: ${SITE_URL}
      # Use real SMTP in production
      GOTRUE_MAILER_AUTOCONFIRM: "false"
      GOTRUE_SMTP_HOST: ${SMTP_HOST}
      GOTRUE_SMTP_PORT: ${SMTP_PORT}
      GOTRUE_SMTP_USER: ${SMTP_USER}
      GOTRUE_SMTP_PASS: ${SMTP_PASS}

  # Crawler for production
  # Uses pre-built image from CI/CD (GHCR or ECR)
  # Crawler is a CORE service and runs by default
  crawler:
    # IMPORTANT: Override with image, no build in production
    # Setting build: null doesn't work - must omit build entirely
    # and re-declare the service to override base config
    image: ${REGISTRY}/${IMAGE_PREFIX}crawler:${IMAGE_TAG}
    container_name: atlasp2p-crawler
    env_file:
      - .env
    environment:
      - SUPABASE_URL=http://kong:8000
      - GEOIP_DB_PATH=/app/data/geoip
      # Prod mode: web listens on 3000
      - WEB_PORT=3000
    volumes:
      - geoip-data:/app/data/geoip
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      db:
        condition: service_healthy
      kong:
        condition: service_started
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  geoip-data:
  atlasp2p_caddy-data:
  atlasp2p_caddy-config:
