# ============================================
# ATLASP2P - CLOUD SUPABASE MODE
# ============================================
# Use with Supabase Cloud (managed database)
# Only runs web app + crawler
# All DB/Auth/Storage handled by Supabase Cloud
#
# Development:
#   make cloud-dev
#
# Production (add Caddy for SSL):
#   make prod-cloud
# ============================================

services:
  # ===========================================
  # WEB APPLICATION
  # ===========================================
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      target: ${WEB_TARGET:-production}
    container_name: atlasp2p-web
    ports:
      - "${PORT:-4000}:${PORT:-4000}"
    env_file:
      - .env
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      # Cloud mode: internal URL = public URL (no local Kong)
      - SUPABASE_INTERNAL_URL=${NEXT_PUBLIC_SUPABASE_URL}
    volumes:
      # Persist avatars (if using local storage instead of Supabase Storage)
      - avatar-storage:/app/public/avatars
      # Persist Next.js build cache
      - web-next-cache:/app/apps/web/.next/cache
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:${PORT:-4000}/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # CRAWLER SERVICE
  # ===========================================
  crawler:
    build:
      context: .
      dockerfile: Dockerfile.crawler
    container_name: atlasp2p-crawler
    env_file:
      - .env
    environment:
      # Cloud mode: use public Supabase URL
      - SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - GEOIP_DB_PATH=/app/data/geoip
    volumes:
      - geoip-data:/app/data/geoip
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "pgrep", "-f", "python"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  avatar-storage:
  web-next-cache:
  geoip-data:

networks:
  default:
    name: atlasp2p-network
